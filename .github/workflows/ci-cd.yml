# .github/workflows/ci-cd.yml
name: CI/CD Pipeline con Estrategia de Despliegue

# ğŸ”” Disparador: Se ejecuta en cada push a la rama principal (main)
on:
  push:
    branches:
      - main

jobs:
  # 1. ğŸ§ª IntegraciÃ³n Continua (CI) - Ejecutar Pruebas
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar Dependencias
        run: npm install

      - name: Ejecutar Pruebas AutomÃ¡ticas
        run: npm test

  # 2. ğŸ—ï¸ IntegraciÃ³n Continua (CI) - Construir Imagen Docker
  build-docker:
    needs: test # ğŸ›‘ Depende de que las pruebas sean exitosas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CÃ³digo
        uses: actions/checkout@v4
      
      # ğŸ”’ Login en Docker Hub usando Secretos
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} 
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Construir, Taggear y Subir (Push) la Imagen
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # âœ… CORRECCIÃ“N: Usamos el formato multilinea para definir ambos tags (SHA y latest)
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/mi-app-ci-cd:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/mi-app-ci-cd:latest

  # 3. ğŸš€ Despliegue Continuo (CD) - Estrategia Simulada (Blue/Green o Canary)
  deploy-strategy-simulated:
    needs: build-docker # ğŸ›‘ Depende de la imagen Docker construida
    runs-on: ubuntu-latest
    environment: 
      name: produccion-canary 
    steps:
      - name: Despliegue Parcial (Canary/Blue) con Secretos
        run: |
          echo "Simulando el comando de despliegue a la infraestructura Blue (ej. Railway/AWS)"
          echo "VersiÃ³n a desplegar: ${{ github.sha }}"
        env:
          # Inyectamos el Secreto como variable de entorno para que la app (index.js) lo use
          WELCOME_MESSAGE: ${{ secrets.WELCOME_MESSAGE }} 

      - name: SimulaciÃ³n de MonitorizaciÃ³n y Prueba de Humo
        run: |
          echo "Esperando 10 segundos para monitorizar el trÃ¡fico del servidor Blue..."
          sleep 10 
          echo "MonitorizaciÃ³n OK. VersiÃ³n estable."

      - name: PromociÃ³n a ProducciÃ³n Completa (Green)
        run: |
          echo "Promoviendo la versiÃ³n ${{ github.sha }} como la versiÃ³n principal (Green)."
          echo "Clave de API de Despliegue: ${{ secrets.API_KEY }}"